{# SPDX-FileCopyrightText: 2025 JWP Consulting GK #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}
{% extends "dashboard_base.html" %}
{% load projectify %}
{% load rules %}
{% load i18n %}
{% block dashboard_content %}
    <div class="min-w-0 grow flex h-full flex-col p-4 pt-0">
        <div class="sticky top-0 flex flex-row flex-wrap items-center justify-between gap-x-2 gap-y-4 bg-foreground pb-8 pt-4 lg:flex-nowrap">
            <div class="flex shrink flex-row items-center gap-6">
                <div class="shrink-0">
                    <a href="{% url "dashboard:projects:detail" task.section.project.uuid %}"
                       class="block w-8 h-8 p-1.5 rounded-full border border-transparent text-base-content hover:bg-secondary-hover active:bg-disabled-background"
                       aria-label="{% trans 'Go back to section' %}">{% icon "x" %}</a>
                </div>
                {% include "workspace/task/breadcrumbs.html" with section=task.section task=task %}
            </div>
            <div class="flex items-center justify-between gap-4 sm:flex-row">
                {% has_perm "workspace.update_task" user task.workspace as can_update_task %}
                {% if can_update_task %}
                    {% go_to_action "dashboard:tasks:update" label=_("Edit") title=_("Edit this task") task_uuid=task.uuid %}
                {% endif %}
                {% circle_anchor label=_("Task menu") title=_("Open task context menu") icon_style="dots-vertical" href="dashboard:tasks:actions" task_uuid=task.uuid %}
            </div>
        </div>
        <div class="flex flex-col gap-8">
            <table class="flex w-full max-w-xl flex-col gap-y-4 sm:grid sm:grid-cols-4">
                <tbody class="contents">
                    <tr class="contents">
                        <th scope="row" class="col-span-1 text-left font-bold">{% trans "Task title" %}</th>
                        <td class="col-span-3 flex flex-row gap-4 items-center">
                            {{ task.title }}
                            {% circle_anchor label=_("Edit task title") icon_style="pencil" href="dashboard:tasks:update" title=_("Edit task title") size=4 task_uuid=task.uuid %}
                        </td>
                    </tr>
                    <tr class="contents">
                        <th scope="row" class="col-span-1 text-left font-bold">{% trans "Assignee" %}</th>
                        <td class="col-span-3 flex flex-row gap-2 items-center">
                            <button class="flex w-full flex-row items-center gap-2 rounded-2.5xl border-primary px-2 py-1 font-bold text-primary bg-task-hover"
                                    type="button"
                                    disabled="">
                                {% user_avatar task.assignee %}
                                <div class="truncate">{{ task.assignee|default:"No team member assigned" }}</div>
                            </button>
                            {% circle_anchor label=_("Edit assignee") icon_style="pencil" href="dashboard:tasks:update" title=_("Edit assignee") size=4 task_uuid=task.uuid %}
                        </td>
                    </tr>
                    <tr class="contents">
                        <th scope="row" class="col-span-1 text-left font-bold">{% trans "Labels" %}</th>
                        <td class="col-span-3 gap-2 flex flex-row items-center">
                            <div class="flex flex-row flex-wrap items-center gap-x-1 gap-y-2">
                                {% for label in task.labels.all %}
                                    <div class="shrink-0">
                                        <button class="group rounded-2.5xl px-3 py-1 font-bold {{ label.bg_class }} {{ label.text_class }}"
                                                type="button"
                                                disabled="">{{ label.name }}</button>
                                    </div>
                                {% endfor %}
                            </div>
                            {% circle_anchor label=_("Edit labels") icon_style="pencil" href="dashboard:tasks:update" title=_("Edit labels") size=4 task_uuid=task.uuid %}
                        </td>
                    </tr>
                    <tr class="contents">
                        <th scope="row" class="col-span-1 text-left font-bold">{% trans "Due date" %}</th>
                        <td class="col-span-3 flex flex-row gap-4 items-center">
                            {% if task.due_date %}
                                {{ task.due_date.date.isoformat }}
                            {% else %}
                                <p class="text-base-content">{% trans "No due date" %}</p>
                            {% endif %}
                            {% circle_anchor label=_("Edit due date") icon_style="pencil" href="dashboard:tasks:update" title=_("Edit due date") size=4 task_uuid=task.uuid %}
                        </td>
                    </tr>
                    <tr class="contents">
                        <th scope="row" class="col-span-1 text-left font-bold">{% trans "Description" %}</th>
                        <td class="col-span-3 flex w-full flex-row items-center gap-4">
                            {% if task.description %}
                                <p>{{ task.description }}</p>
                            {% else %}
                                <p class="text-base-content">{% trans "No description" %}</p>
                            {% endif %}
                            {% circle_anchor label=_("Edit description") icon_style="pencil" href="dashboard:tasks:update" title=_("Edit description") size=4 task_uuid=task.uuid %}
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="flex flex-col gap-4">
                <div class="flex flex-row items-center gap-4">
                    <h4 class="text-xl font-bold">{% trans "Sub tasks" %}</h4>
                    {% circle_anchor label=_("Edit sub tasks") icon_style="pencil" href="dashboard:tasks:update" title=_("Edit sub tasks") size=4 task_uuid=task.uuid %}
                </div>
                {% if task.sub_task_progress %}
                    <div class="flex flex-row items-center gap-4">
                        <div class="h-2 w-full overflow-hidden rounded bg-disabled">
                            {# djlint:off H021 #}
                            <div class="h-full bg-primary"
                                 style="width: {{ task.sub_task_progress|percent }}"></div>
                        </div>
                        <p class="min-w-max font-bold">{{ task.sub_task_progress|percent }}</p>
                    </div>
                {% endif %}
            </div>
            <div id="subtasks" class="flex grow flex-col px-4">
                {% for sub_task in task.subtask_set.all %}
                    <div class="flex grow flex-row items-center gap-2 px-2 py-1">
                        <div class="size-4 shrink-0 rounded border border-secondary-hover"
                             role="img"
                             aria-label="{% if sub_task.done %}{% trans 'Subtask completed' %}{% else %}{% trans 'Subtask not completed' %}{% endif %}">
                            {% if sub_task.done %}
                                {% icon "check" size=4 %}
                            {% endif %}
                        </div>
                        <div class="shrink flex min-w-0 items-center gap-2">
                            <p class="h-full w-full truncate overflow-x-hidden">{{ sub_task.title }}</p>
                            {% circle_anchor label=_("Edit sub task") icon_style="pencil" href="dashboard:tasks:update" title=_("Edit sub task") size=4 task_uuid=task.uuid %}
                        </div>
                    </div>
                {% empty %}
                    <p class="text-base-content">
                        {% blocktrans %}This task has no sub tasks. You can add sub tasks by going to the task edit screen and clicking the <strong>Add sub task</strong> button from there.{% endblocktrans %}
                    </p>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock dashboard_content %}
