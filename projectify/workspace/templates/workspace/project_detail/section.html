{# SPDX-FileCopyrightText: 2024-2026 JWP Consulting GK #}
{# SPDX-License-Identifier: AGPL-3.0-or-later #}
{% load i18n %}
{% load projectify %}
<section class="flex flex-col" id="section-{{ section.uuid }}">
    <form method="post"
          hx-post="{% url 'dashboard:projects:detail' section.project.uuid %}"
          hx-target="#section-{{ section.uuid }}"
          hx-swap="outerHTML"
          hx-include="#task-filter,#team-member-filters,#label-filters"
          class="sticky top-0 flex w-full flex-row items-center justify-between bg-foreground px-4 py-2 gap-3">
        <input type="hidden" name="action" value="minimize_section">
        <input type="hidden" name="section" value="{{ section.uuid }}">
        <input type="hidden"
               name="minimized"
               value="{% if section.minimized %}false{% else %}true{% endif %}">
        {% csrf_token %}
        <div class="flex min-w-0 shrink flex-row gap-4 items-center text-base-content">
            <button type="submit"
                    class="size-5 shrink-0 flex items-center justify-center hover:bg-secondary-hover rounded transition-transform duration-200 {% if section.minimized %}rotate-[-90deg]{% endif %}"
                    aria-label="{% if section.minimized %}{% translate 'Expand section' %}{% else %}{% translate 'Minimize section' %}{% endif %}">
                {% icon "chevron-down" %}
            </button>
            <div class="min-w-0 flex flex-row gap-2 items-center">
                <h1 class="truncate font-bold">{{ section.title }}</h1>
                {% circle_anchor label=_("Update section") icon_style="pencil" href="dashboard:sections:update" section_uuid=section.uuid size=4 %}
            </div>
        </div>
        <div class="flex shrink-0 flex-row items-center gap-1">
            {% include "workspace/common/loading_spinner.html" %}
            {% go_to_action href="dashboard:sections:create-task" label=_("Add task") style="secondary" icon_style="plus" section_uuid=section.uuid %}
        </div>
    </form>
    {% if not section.minimized %}
        <table class="flex flex-col gap-2 rounded-b-2xl bg-foreground p-4 lg:grid lg:grid-cols-[8fr_3fr_max-content] lg:gap-2 lg:items-center">
            <tbody class="contents">
                {% for task in section.task_set.all %}
                    <tr class="flex w-full flex-col items-center gap-1 rounded-lg border border-border p-3 lg:contents">
                        <td class="contents">
                            <a href="{% url 'dashboard:tasks:detail' task.uuid %}"
                               class="flex flex-row items-start items-center gap-1 self-start sm:gap-6 lg:self-center ">
                                <span class="shrink-0 font-bold">#{{ task.number }}</span>
                                <span class="line-clamp-3 justify-self-start hover:text-primary lg:line-clamp-1 lg:h-6">{{ task.title }}</span>
                            </a>
                        </td>
                        <td class="flex w-full flex-row items-center justify-start gap-1 self-start overflow-x-auto">
                            {% for label in task.labels.all %}
                                <div class="max-w-xs shrink-0 overflow-hidden text-ellipsis whitespace-nowrap rounded-full px-3 py-1 font-bold {{ label.bg_class }} {{ label.text_class }}">
                                    {{ label.name }}
                                </div>
                            {% endfor %}
                        </td>
                        <td class="flex flex-row justify-end items-center gap-2">
                            {% if task.sub_task_progress %}
                                <div class="flex shrink-0 flex-row items-center gap-0.5 justify-between px-2 py-1">
                                    <div class="size-5 shrink-0">{% icon "view-list" "primary" %}</div>
                                    <div class="font-bold text-primary">{{ task.sub_task_progress|percent }}</div>
                                </div>
                            {% endif %}
                            {% user_avatar task.assignee %}
                            <form hx-target="#section-{{ section.uuid }}"
                                  hx-post="{% url 'dashboard:projects:detail' project.uuid %}"
                                  hx-include="#task-filter,#team-member-filters,#label-filters"
                                  class="flex flex-row items-center gap-1"
                                  hx-swap="outerHTML"
                                  method="post">
                                <input type="hidden" name="action" value="move_task">
                                <input type="hidden" name="task_uuid" value="{{ task.uuid }}">
                                <div hx-swap="outerHTML">
                                    {% circle_button label=_("Move task up") value="up" name="direction" disabled=task.first icon_style="chevron-up" %}
                                    {% circle_button label=_("Move task down") value="down" name="direction" disabled=task.last icon_style="chevron-down" %}
                                </div>
                                {% csrf_token %}
                                <p class="htmx-indicator">...</p>
                                <a aria-label="Navigate to task menu"
                                   hx-boost
                                   hx-target="#project-detail"
                                   hx-select="#task-actions"
                                   href="{% url "dashboard:tasks:actions" task.uuid %}"
                                   class="size-8 p-1.5 rounded-full border border-transparent hover:bg-secondary-hover active:bg-disabled-background">
                                    {% icon "dots-horizontal" %}
                                </a>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr class="contents">
                        <td class="lg:col-span-3">
                            {% if section.has_tasks %}
                                {% translate "No tasks found for your search." %}
                            {% else %}
                                {% translate "No tasks in this section." %}
                                {% anchor 'dashboard:sections:create-task' label=_("Add a task here") section_uuid=section.uuid %}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</section>
